<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Amazon Echo Bridge Configuration</title>
    <style>
        body {
            padding-top: 60px;
            padding-bottom: 20px;
        }
    </style>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.js"></script>
    <script type="text/javascript">
        angular.module('configurator', [])
                .service('bridgeService', ["$http", function ($http) {
                    var self = this;
                    this.state = {base: window.location.origin + "/api/devices", devices: [], error: ""};

                    this.viewDevices = function () {
                        this.state.error = "";
                        return $http.get(this.state.base).then(
                                function (response) {
                                    self.state.devices = response.data[0].content;
                                },
                                function (error) {
                                    if (error.data) {
                                        self.state.error = error.data.message;
                                    } else {
                                        self.state.error = "If you're not seeing any devices, you may be running into problems with CORS. " +
                                                "You can work around this by running a fresh launch of Chrome with the --disable-web-security flag.";
                                    }
                                    console.log(error);
                                }
                        );
                    };

                    this.addDevice = function (name, type, onUrl, offUrl) {
                        this.state.error = "";
                        return $http.post(this.state.base, {
                            name: name,
                            deviceType: type,
                            onUrl: onUrl,
                            offUrl: offUrl
                        }).then(
                                function (response) {
                                    self.viewDevices();
                                },
                                function (error) {
                                    if (error.data) {
                                        self.state.error = error.data.message;
                                    }
                                    console.log(error);
                                }
                        );
                    };

                    this.deleteDevice = function (id) {
                        this.state.error = "";
                        return $http.delete(this.state.base + "/" + id).then(
                                function (response) {
                                    self.viewDevices();
                                },
                                function (error) {
                                    if (error.data) {
                                        self.state.error = error.data.message;
                                    }
                                    console.log(error);
                                }
                        );
                    };
                }])

                .controller('ViewingController', ["$scope", "bridgeService", function ($scope, bridgeService) {
                    bridgeService.viewDevices();
                    $scope.bridge = bridgeService.state;
                    $scope.deleteDevice = function (device) {
                        bridgeService.deleteDevice(device.id);
                    };
                    $scope.testUrl = function (url) {
                        window.open(url, "_blank");
                    };
                    $scope.setBridgeUrl = function (url) {
                        bridgeService.state.base = url;
                        bridgeService.viewDevices();
                    }
                }])

                .controller('AddingController', ["$scope", "bridgeService", function ($scope, bridgeService) {

                    $scope.bridge = bridgeService.state;
                    $scope.device = {id: "", name: "", type: "switch", onUrl: "", offUrl: ""};
                    $scope.vera = {base: "", port: "3480", id: ""};

                    $scope.buildUrls = function () {
                        if ($scope.vera.base.indexOf("http") < 0) {
                            $scope.vera.base = "http://" + $scope.vera.base;
                        }
                        $scope.device.onUrl = $scope.vera.base + ":" + $scope.vera.port
                                + "/data_request?id=action&output_format=json&serviceId=urn:upnp-org:serviceId:SwitchPower1&action=SetTarget&newTargetValue=1&DeviceNum="
                                + $scope.vera.id;
                        $scope.device.offUrl = $scope.vera.base + ":" + $scope.vera.port
                                + "/data_request?id=action&output_format=json&serviceId=urn:upnp-org:serviceId:SwitchPower1&action=SetTarget&newTargetValue=0&DeviceNum="
                                + $scope.vera.id;
                    };

                    $scope.testUrl = function (url) {
                        window.open(url, "_blank");
                    };

                    $scope.addDevice = function () {
                        bridgeService.addDevice($scope.device.name, $scope.device.type, $scope.device.onUrl, $scope.device.offUrl).then(
                                function () {
                                    $scope.device.id = "";
                                    $scope.device.name = "";
                                    $scope.device.onUrl = "";
                                    $scope.device.offUrl = "";
                                },
                                function (error) {
                                }
                        );
                    }
                }])

                .controller('ErrorsController', ["$scope", "bridgeService", function ($scope, bridgeService) {
                    $scope.bridge = bridgeService.state;
                }])
    </script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</head>
<body ng-app="configurator">

<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">Amazon Echo Bridge Configuration</a>
        </div>
    </div>
</nav>

<div class="container">
    <div ng-controller="ViewingController">

        <div class="panel panel-default bridgeServer">
            <div class="panel-heading"><h1 class="panel-title">Bridge settings</h1></div>
            <div class="panel-body">

                <form class="form-horizontal">
                    <label class="col-xs-12 col-sm-3 control-label" for="bridge-base">Bridge server</label>

                    <div class="col-xs-8 col-sm-7">
                        <input id="bridge-base" class="form-control" type="text" ng-model="bridge.base"
                               placeholder="URL to bridge">
                    </div>
                    <button type="submit" class="col-xs-2 col-sm-1 btn btn-primary"
                            ng-click="setBridgeUrl(bridge.base)">Load
                    </button>
                    <button type="submit" class="col-xs-2 col-sm-1 btn btn-primary" ng-click="testUrl(bridge.base)">Go
                    </button>
                </form>
            </div>
        </div>

        <div ng-controller="ErrorsController">
            <div ng-if="bridge.error" class="alert alert-warning alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>

                <h2 ng-show='bridge.error != ""'>ERROR</h2>

                <div ng-show='bridge.error != ""'>
                    {{bridge.error}}
                </div>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading"><h2 class="panel-title">Current devices</h2></div>
            <table class="table table-bordered table-striped table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tr ng-repeat="device in bridge.devices">
                    <td>{{device.id}}</td>
                    <td>{{device.name}}</td>
                    <td>{{device.deviceType}}</td>
                    <td>
                        <button class="btn btn-info" type="submit" ng-click="testUrl(device.onUrl)">Test ON</button>
                        <button class="btn btn-info" type="submit" ng-click="testUrl(device.offUrl)">Test OFF</button>
                        <button class="btn btn-danger" type="submit" ng-click="deleteDevice(device)">Delete</button>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div ng-controller="AddingController">
        <div class="panel panel-default bridgeServer" ng-if="!bridge.error">
            <div class="panel-heading"><h2 class="panel-title">Add a new device</h2></div>
            <ul class="list-group">
                <li class="list-group-item">
                    <p class="text-muted">You can generate on/off URLs by filling in the Vera server URL, port, and
                        device ID; or you can fill them out manually in the lower section.</p>

                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-2 control-label" for="vera-base">Vera Server URL </label>

                            <div class="col-xs-12 col-sm-10">
                                <input type="text" class="form-control" id="vera-base" ng-model="vera.base"
                                       placeholder="Vera URL (e.g. http://192.168.1.100)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-2 col-sm-2 control-label" for="vera-port">Vera Request Port </label>

                            <div class="col-xs-10 col-sm-2">
                                <input type="text" class="form-control" id="vera-port" ng-model="vera.port"
                                       placeholder="Vera Port (typically 3480)">
                            </div>

                            <label class="col-xs-2 col-sm-2 control-label" for="vera-id">Device ID </label>

                            <div class="col-xs-10 col-sm-2">
                                <input type="text" class="form-control" id="vera-id" ng-model="vera.id"
                                       placeholder="ID">
                            </div>
                            <button type="button"
                                    class="col-xs-offset-2 col-sm-offset-1 col-xs-4 col-sm-2 btn btn-success"
                                    ng-click="buildUrls()">Generate
                                URLs
                            </button>
                        </div>
                    </form>
                </li>
                <li class="list-group-item">
                    <form class="form-horizontal" ng-submit="addDevice()">
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-2 control-label" for="device-name">Name </label>

                            <div class="col-xs-8 col-sm-7">
                                <input type="text" class="form-control" id="device-name" ng-model="device.name"
                                       placeholder="Device Name">
                            </div>
                            <button type="submit" class="col-xs-4 col-sm-2 btn btn-primary">Add Device</button>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-2 control-label" for="device-on-url">On URL </label>

                            <div class="col-xs-8 col-sm-7">
                                <input type="text" class="form-control" id="device-on-url" ng-model="device.onUrl"
                                       placeholder="URL to turn device on">
                            </div>
                            <button class="col-xs-4 col-sm-2 btn btn-success" type="button"
                                    ng-click="testUrl(device.onUrl)">Test
                            </button>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-12 col-sm-2 control-label" for="device-off-url">Off URL </label>

                            <div class="col-xs-8 col-sm-7">
                                <input type="text" class="form-control" id="device-off-url" ng-model="device.offUrl"
                                       placeholder="URL to turn device off">
                            </div>
                            <button class="col-xs-4 col-sm-2 btn btn-success" type="button"
                                    ng-click="testUrl(device.offUrl)">Test
                            </button>
                        </div>
                    </form>
                </li>
            </ul>
        </div>
    </div>
</div>

</div>
</body>
</html>